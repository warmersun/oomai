%import common.WS
%ignore WS

// Terminals for keywords (case-insensitive)
match: /match/i
optional: /optional/i
unwind: /unwind/i
as: /as/i
with: /with/i
return: /return/i
union: /union/i
all: /all/i
distinct: /distinct/i
where: /where/i
order: /order/i
by: /by/i
asc: /asc/i
ascending: /ascending/i
desc: /desc/i
descending: /descending/i
skip: /skip/i
limit: /limit/i
shortestpath: /shortestpath/i
allshortestpaths: /allshortestpaths/i
is: /is/i
or: /or/i
xor: /xor/i
and: /and/i
not: /not/i
starts: /starts/i
with_kw: /with/i
ends: /ends/i
contains: /contains/i
in: /in/i
null: /null/i
true: /true/i
false: /false/i
count: /count/i
case: /case/i
when: /when/i
then: /then/i
else: /else/i
end: /end/i
exists: /exists/i
trim: /trim/i
reduce: /reduce/i
any: /any/i
single: /single/i
none: /none/i

// Terminals for literals and identifiers
STRING_LITERAL: /'((?:\\.|''|[^'\\])*)'/ | /"((?:\\.|""|[^"\\])*)"/
DELIMITED_IDENTIFIER: /`((?:``|[^`])*)`/
IDENTIFIER: /[a-zA-Z_]\w*/
UNSIGNED_DECIMAL_INTEGER: /\d+/
SIGNED_NUMERIC_LITERAL: ("-")? (UNSIGNED_DECIMAL_INTEGER | /inf/i | /infinity/i) | /nan/i
// Simplify numeric for brevity; expand as needed for full support

// Start rule
?start: program

program: statement

statement: composite_statement

composite_statement: linear_statement (union set_quantifier? linear_statement)*

linear_statement: primitive_statement+ primitive_result_statement?

primitive_statement: primitive_query_statement

primitive_query_statement: match_statement | unwind_statement | with_statement

match_statement: optional_match_statement | simple_match_statement

optional_match_statement: optional simple_match_statement

simple_match_statement: match graph_pattern_binding_table

unwind_statement: unwind value_expression as binding_variable

with_statement: with return_statement_body order_by_and_page_clause? where_clause?

primitive_result_statement: return_statement

return_statement: return return_statement_body order_by_and_page_clause?

return_statement_body: set_quantifier? return_item_list

return_item_list: ("*" | return_item) ("," return_item)*

return_item: value_expression return_item_alias?

return_item_alias: as identifier

order_by_and_page_clause: order_by_clause offset_clause? limit_clause? 
                        | offset_clause limit_clause? 
                        | limit_clause

order_by_clause: order by sort_specification_list

sort_specification_list: sort_specification ("," sort_specification)*

sort_specification: sort_key ordering_specification?

sort_key: value_expression

ordering_specification: ascending_order | descending_order

ascending_order: asc | ascending

descending_order: desc | descending

offset_clause: skip value_expression

limit_clause: limit value_expression

graph_pattern_binding_table: graph_pattern

where_clause: where search_condition

set_quantifier: all | distinct

graph_pattern: path_pattern_list graph_pattern_where_clause?

path_pattern_list: path_pattern ("," path_pattern)*

graph_pattern_where_clause: where_clause

path_pattern: path_variable_declaration? path_pattern_expression

path_variable_declaration: binding_variable "="

path_pattern_expression: path_term | legacy_shortest_path_pattern

legacy_shortest_path_pattern: (shortestpath | allshortestpaths) "(" node_pattern relationship_pattern node_pattern ")"

path_term: path_factor+

path_factor: path_primary | path_primary graph_pattern_quantifier

path_primary: element_pattern | "(" subpath_variable_declaration? path_pattern_expression parenthesized_path_pattern_where_clause? ")"

subpath_variable_declaration: binding_variable "="

parenthesized_path_pattern_where_clause: where value_expression

element_pattern: node_pattern | relationship_pattern

node_pattern: "(" node_pattern_filler? ")"

node_pattern_filler: binding_variable is_node_label_expression? element_pattern_predicate? 
                   | is_node_label_expression element_pattern_predicate? 
                   | element_pattern_predicate

element_pattern_predicate: element_pattern_where_clause | element_property_specification

element_pattern_where_clause: where value_expression

element_property_specification: "{" property_key_value_pair_list "}"

property_key_value_pair_list: property_key_value_pair ("," property_key_value_pair)*

property_key_value_pair: property_name ":" value_expression

relationship_pattern: full_relationship_pattern

full_relationship_pattern: full_relationship_pointing_left | full_relationship_pointing_right | full_relationship_left_or_right | full_relationship_any_direction

full_relationship_pointing_left: "<" "-" ("[" relationship_pattern_filler? "]")? "-"

full_relationship_pointing_right: "-" ("[" relationship_pattern_filler? "]")? "-" ">"

full_relationship_left_or_right: "<" "-" ("[" relationship_pattern_filler? "]")? "-" ">"

full_relationship_any_direction: "-" ("[" relationship_pattern_filler? "]")? "-"

relationship_pattern_filler: binding_variable is_relationship_label_expression? path_length? element_pattern_predicate? 
                           | is_relationship_label_expression path_length? element_pattern_predicate? 
                           | path_length element_pattern_predicate? 
                           | element_pattern_predicate

path_length: "*" (lower_and_upper_bound_path_length | fixed_path_length)?

lower_and_upper_bound_path_length: lower_bound_path_length? ".." upper_bound_path_length?

fixed_path_length: UNSIGNED_DECIMAL_INTEGER

graph_pattern_quantifier: "*" | "+" | "{" UNSIGNED_DECIMAL_INTEGER "}" | "{" lower_bound_path_length? "," upper_bound_path_length? "}"

lower_bound_path_length: UNSIGNED_DECIMAL_INTEGER

upper_bound_path_length: UNSIGNED_DECIMAL_INTEGER

is_node_label_expression: ":" node_label_expression_legacy | is_label_expression

is_relationship_label_expression: ":" relationship_label_expression_legacy | is_label_expression

is_label_expression: (":" | is) label_expression

node_label_expression_legacy: label_name (":" label_name)*

relationship_label_expression_legacy: label_name ("|" ":" label_name)*

label_expression: label_term | label_expression "|" label_term

label_term: label_factor | label_term "&" label_factor

label_factor: label_primary | "!" label_primary

label_primary: label_name | "(" label_expression ")" | "%"

label_name: identifier

property_name: identifier

binding_variable: identifier

identifier: IDENTIFIER | DELIMITED_IDENTIFIER

value_expression: boolean_value_expression

search_condition: boolean_value_expression

boolean_value_expression: boolean_term_xor | boolean_value_expression or boolean_term_xor

boolean_term_xor: boolean_term | boolean_term_xor xor boolean_term

boolean_term: boolean_factor | boolean_term and boolean_factor

boolean_factor: not* boolean_primary

boolean_primary: pattern_expression | predicate

predicate: comparison_predicate

comparison_predicate: simple_comparison_predicand simple_comparison_predicate_part_2*

simple_comparison_predicand: advanced_comparison_predicand advanced_comparison_predicate_part_2?

simple_comparison_predicate_part_2: simple_comp_op advanced_comparison_predicand

simple_comp_op: "=" | "<>" | "<" | ">" | "<=" | ">="

advanced_comparison_predicand: arithmetic_value_expression

advanced_comparison_predicate_part_2: advanced_comp_op advanced_comparison_predicand | "IS" not? "NULL" | is_label_expression

advanced_comp_op: contains | in | "=~" | starts with_kw | ends with_kw

arithmetic_value_expression: arithmetic_term | arithmetic_value_expression "+" arithmetic_term | arithmetic_value_expression "-" arithmetic_term

arithmetic_term: arithmetic_factor | arithmetic_term "*" arithmetic_factor | arithmetic_term "/" arithmetic_factor | arithmetic_term "%" arithmetic_factor

arithmetic_factor: arithmetic_unary | arithmetic_factor "^" arithmetic_unary

arithmetic_unary: ("+" | "-")? postfix_expression

postfix_expression: value_expression_primary | postfix_expression postfix_operator

postfix_operator: "." property_name | "[" value_expression "]" | "[" slicing_from? ".." slicing_to? "]"

slicing_from: value_expression

slicing_to: value_expression

value_expression_primary: "(" value_expression ")" | non_parenthesized_value_expression_primary

non_parenthesized_value_expression_primary: general_parameter_reference | case_expression | count_star | exists_expression | map_projection | list_comprehension | pattern_comprehension | reduce_expression | quantifier_expression | trim_function | shortest_path_expression | function_invocation | value_specification | binding_variable

case_expression: simple_case | search_case

simple_case: case value_expression simple_when_clause+ else_clause? end

search_case: case searched_when_clause+ else_clause? end

simple_when_clause: when when_operand_list then value_expression

searched_when_clause: when search_condition then value_expression

when_operand_list: when_operand ("," when_operand)*

when_operand: value_expression

else_clause: else value_expression

exists_expression: exists "{" graph_pattern "}"

map_projection: binding_variable "{" map_projection_element_list? "}"

map_projection_element_list: map_projection_element ("," map_projection_element)*

map_projection_element: property_name ":" value_expression | "." property_name | binding_variable | ".*"

list_comprehension: "[" list_element_source list_element_filter_and_projection? "]"

list_element_filter_and_projection: list_element_filter list_element_projection? | list_element_filter

list_element_source: binding_variable in value_expression

list_element_filter: where value_expression

list_element_projection: "|" value_expression

pattern_comprehension: "[" pattern_source pattern_filter_and_projection "]"

pattern_source: (binding_variable "=")? simple_path_pattern

pattern_filter_and_projection: pattern_filter? pattern_projection

pattern_filter: where value_expression

pattern_projection: "|" value_expression

reduce_expression: reduce "(" binding_variable "=" value_expression "," binding_variable in value_expression "|" value_expression ")"

quantifier_expression: quantifier "(" binding_variable in value_expression where value_expression ")"

quantifier: all | any | single | none

trim_function: trim "(" value_expression ")"

function_invocation: function_reference "(" set_quantifier? function_argument_list? ")"

function_argument_list: function_argument ("," function_argument)*

function_argument: value_expression

function_reference: (object_name ".")* function_name

function_name: identifier

count_star: count "(" "*" ")"

pattern_expression: simple_path_pattern

shortest_path_expression: legacy_shortest_path_pattern

simple_path_pattern: node_pattern (relationship_pattern node_pattern)*

value_specification: literal | general_parameter_reference | "[" list_element_list? "]" | "{" field_list? "}"

list_element_list: value_expression ("," value_expression)*

field_list: field ("," field)*

field: field_name ":" value_expression

literal: SIGNED_NUMERIC_LITERAL | boolean_literal | STRING_LITERAL | null | "[" list_element_list_literal? "]" | "{" field_list_literal? "}"

list_element_list_literal: literal ("," literal)*

field_list_literal: field_literal ("," field_literal)*

field_literal: field_name ":" literal

general_parameter_reference: "$" parameter_name

parameter_name: identifier

field_name: identifier

boolean_literal: true | false

object_name: identifier
%import common.WS
%ignore WS
%import common.INT      -> INT
%import common.SIGNED_NUMBER  -> NUMBER

STRING: /'([^'\\]|\\.)*'/ | /"([^"\\]|\\.)*"/

NAME: /[A-Za-z_]\w*/
LNAME: /[a-z_][a-z0-9_]*/
BIND: LNAME
ID: NAME | /`([^`]*(``[^`]*)*)`/

TRUE: "TRUE"
FALSE: "FALSE"
NULL: "NULL"

?start: stmt
?stmt: block ( "UNION" ("ALL"|"DISTINCT")? block )*
block: (unwind | match | with)+ ret?
unwind: "UNWIND" expr "AS" BIND
match: ["OPTIONAL"] "MATCH" pattern where?
with: "WITH" ret_body where? order? skip? limit?
ret: "RETURN" ret_body order? skip? limit?

ret_body: ("ALL"|"DISTINCT")? ("*" | item ("," item)*)
item: expr ["AS" ID]

order: "ORDER" "BY" sort_item ("," sort_item)*
sort_item: expr ["ASC"|"DESC"]
skip: "SKIP" expr
limit: "LIMIT" expr
where: "WHERE" bool

pattern: path ("," path)* where?
path: [BIND "="] pexpr
pexpr: shortest | node (rel node)*

node: "(" [node_inside] ")"
node_inside: BIND? labels? props?
labels: (":" label)+
label: ID
props: "{" (pair ("," pair)*)? "}"
pair: ID ":" expr

rel: ("<")? "-" ("[" rel_inside? "]")? "-" (">")?
rel_inside: BIND? rlabels? rlen? props?
rlabels: ":" label ("|" label)*
rlen: "*" ( INT | (INT? ".." INT?) )?

?bool: and_expr ("OR" and_expr)*
?and_expr: not_expr ("AND" not_expr)*
?not_expr: ("NOT")* cmp

?cmp: sum (comp_op sum | "IS" "NULL" | "IS" "NOT" "NULL")*
comp_op: "=" | "<>" | "<" | ">" | "<=" | ">=" | "CONTAINS" | "IN" | "=~" | "STARTS" "WITH" | "ENDS" "WITH"

?sum: term (("+"|"-") term)*
?term: pow (("*"|"/"|"%") pow)*
?pow: unary ("^" unary)*
?unary: ("+"|"-")? postfix

?postfix: primary (("." ID) | ("[" expr "]") | ("[" expr? ".." expr? "]") | (":" label_expr))*
label_expr: label ("|" label)*

?primary: "(" expr ")"
        | param
        | case
        | count
        | func
        | exists
        | map_proj
        | list_comp
        | pat_comp
        | reduce
        | quant
        | shortest
        | literal
        | BIND

param: "$" ID

case: "CASE" expr when_s+ else_c? "END"
    | "CASE" when_b+ else_c? "END"
when_s: "WHEN" expr "THEN" expr
when_b: "WHEN" bool "THEN" expr
else_c: "ELSE" expr

exists: "EXISTS" "{" (match | pattern) "}" | "EXISTS" "(" expr ")"

map_proj: BIND "{" (mp ("," mp)*)? "}"
mp: pair | "." ID | BIND | ".*"

list_comp: "[" BIND "IN" expr ("WHERE" bool)? ("|" expr)? "]"

pat_comp: "[" (BIND "=")? simple_path ("WHERE" bool)? "|" expr "]"
simple_path: node (rel node)*

reduce: "REDUCE" "(" BIND "=" expr "," BIND "IN" expr "|" expr ")"

quant: ("ALL"|"ANY"|"SINGLE"|"NONE") "(" BIND "IN" expr "WHERE" bool ")"

func: NAME "(" ("ALL"|"DISTINCT")? (args)? ")"
args: expr ("," expr)*

count: "COUNT" "(" "*" ")"

shortest: ("SHORTESTPATH"|"ALLSHORTESTPATHS") "(" simple_path ")"

literal: NUMBER | STRING | TRUE | FALSE | NULL | list | props
list: "[" (expr ("," expr)*)? "]"

?expr: bool
